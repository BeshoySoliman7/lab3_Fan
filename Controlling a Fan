#include <Wire.h>
#include "RTClib.h"

#include <LiquidCrystal.h>

RTC_Millis rtc;
int prev_minute = 61;
volatile bool state = HIGH;
const int ENABLE = 5;

int speedPin=5;
int dir1=4;
int dir2=3;
int BP1=8;
int B1Val;
int mSpeed=0;
int dt=500;

LiquidCrystal lcd(6, 7, 22, 23, 24, 25);
const char* FAN_STRS[4] = {"   0", " 1/2", " 3/4", "Full"};
const int FAN_SPEEDS[4] = {0, 127, 192, 255};
bool speed_up = true;
int speed_index = 0;

void update_display() {
    DateTime now = rtc.now();
    lcd.setCursor(0, 0);
    lcd.print("Time:");
    lcd.print(now.hour());
    lcd.print(":");
    lcd.print(now.minute());
    lcd.print(":");
    lcd.print(now.second());
    lcd.print(" ");

    // Motor info
    lcd.setCursor(0, 1);
    if (state) {
      lcd.print("C ");
    } else {
      lcd.print("CC");
    }
    lcd.print(" Speed:");

    lcd.print(FAN_STRS[speed_index]);
}
void set_speed(const int speed) {
    // Set the new speed
    analogWrite(ENABLE, speed);
}
void setup() {
  // put your setup code here, to run once:
pinMode(speedPin,OUTPUT);
pinMode(dir1,OUTPUT);
pinMode(dir2,OUTPUT);
pinMode(BP1,INPUT);
  noInterrupts();
    TCCR1A = 0;
    TCCR1B = 0;
    TCNT1  = 0;
    OCR1A  = 62500 - 1;
    TCCR1B = _BV(WGM12) | _BV(CS12);
    TIMSK1 = _BV(OCIE1A);
    interrupts();
digitalWrite(BP1, HIGH);

Serial.begin(9600);
lcd.begin(16, 2);
rtc.begin(DateTime((__DATE__), (__TIME__)));

 
}
 ISR(TIMER1_COMPA_vect) {
    update_display();
}
void loop() {
  // put your main code here, to run repeatedly:
B1Val=digitalRead(BP1);


 
if (B1Val==0){
  mSpeed=mSpeed-10;
  delay(dt);
}

if (mSpeed>255){
  mSpeed=255;
}
if (mSpeed<-255){
  mSpeed=-255;
}
if (mSpeed==10){
  mSpeed=100;
}
if (mSpeed==-10){
  mSpeed=-100;
}
if (mSpeed==90 || mSpeed ==95){
  mSpeed=0;
}
if (mSpeed==-90 || mSpeed==-95){
  mSpeed=0;
}
if (mSpeed==0){
  analogWrite(speedPin,0);
}
if (mSpeed>0){
digitalWrite(dir1,LOW);
digitalWrite(dir2,HIGH);
analogWrite(speedPin,mSpeed); 
}
if (mSpeed<0){
digitalWrite(dir1,HIGH);
digitalWrite(dir2,LOW);
analogWrite(speedPin,abs(mSpeed)); 
}
}
 
